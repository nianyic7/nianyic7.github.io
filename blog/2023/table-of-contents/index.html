<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>a post with table of contents | Nianyi Chen</title> <meta name="author" content="Nianyi Chen"> <meta name="description" content="an example of a blog post with table of contents"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://nianyic7.github.io/blog/2023/table-of-contents/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="//"><span class="font-weight-bold">Nianyi </span>Chen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">notes<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/projects/">projects</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">a post with table of contents</h1> <p class="post-meta">March 20, 2023</p> <p class="post-tags"> <a href="//blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="//blog/category/sample-posts"> <i class="fas fa-tag fa-sm"></i> sample-posts</a>   <a href="//blog/category/toc"> <i class="fas fa-tag fa-sm"></i> toc</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h1"> <a href="#mp-gadget-code-notes">MP-Gadget Code Notes</a> <ul> <li class="toc-entry toc-h2"><a href="#overview">Overview</a></li> <li class="toc-entry toc-h2"><a href="#io">I/O</a></li> <li class="toc-entry toc-h2"> <a href="#time-integration">Time integration</a> <ul> <li class="toc-entry toc-h4"><a href="#note-on-hubble">note on hubble</a></li> </ul> </li> <li class="toc-entry toc-h2"> <a href="#timestepping">Timestepping</a> <ul> <li class="toc-entry toc-h3"><a href="#timelineconversions">Timeline/Conversions</a></li> <li class="toc-entry toc-h3"><a href="#timestep-calculations">Timestep calculations</a></li> </ul> </li> <li class="toc-entry toc-h2"> <a href="#gravity">Gravity</a> <ul> <li class="toc-entry toc-h3"><a href="#pp-force">PP Force</a></li> <li class="toc-entry toc-h3"><a href="#pm-force">PM Force</a></li> <li class="toc-entry toc-h3"><a href="#units-and-scale-factors">units and scale factors</a></li> </ul> </li> <li class="toc-entry toc-h2"> <a href="#hydrosph">Hydro/SPH</a> <ul> <li class="toc-entry toc-h3"><a href="#entropy">entropy</a></li> <li class="toc-entry toc-h3"><a href="#density-estimation-densityc">density estimation (density.c)</a></li> <li class="toc-entry toc-h3"><a href="#hydrohydrac">hydro(hydra.c)</a></li> </ul> </li> <li class="toc-entry toc-h2"><a href="#heating-cooling-ionization-equilibrium">Heating, Cooling, ionization equilibrium</a></li> <li class="toc-entry toc-h2"><a href="#star-formation">Star-formation</a></li> <li class="toc-entry toc-h2"><a href="#winds-stellar-feedbacks">winds, stellar feedbacks</a></li> <li class="toc-entry toc-h2"><a href="#metal-return">Metal return</a></li> <li class="toc-entry toc-h2"><a href="#parallelization">Parallelization</a></li> </ul> </li> </ul> </div> <hr> <div id="markdown-content"> <p>This post shows how to add a table of contents in the beginning of the post.</p> <h1 id="mp-gadget-code-notes">MP-Gadget Code Notes</h1> <p>Useful resources for understanding cosmological simulations:</p> <ul> <li><a href="http://popia.ft.uam.es/aknebe/page3/files/ComputationalCosmology/" rel="external nofollow noopener" target="_blank">Alexander Knebe’s lecture notes</a></li> <li><a href="https://wwwmpa.mpa-garching.mpg.de/gadget4/gadget4-code-paper.pdf" rel="external nofollow noopener" target="_blank">gadget4 paper</a></li> <li><a href="https://arxiv.org/pdf/astro-ph/9710043.pdf" rel="external nofollow noopener" target="_blank">Quinn97: Time stepping N-body simulations</a></li> <li><a href="https://arxiv.org/pdf/astro-ph/0411730.pdf" rel="external nofollow noopener" target="_blank">Bagla04: Cosmological N-Body Simulations</a></li> <li><a href="https://arxiv.org/pdf/0801.1023.pdf" rel="external nofollow noopener" target="_blank">Dolag08: Simulation techniques for cosmological simulations</a></li> <li><a href="https://workshops.ift.uam-csic.es/uploads/charla/275/Yepes_nbody.pdf" rel="external nofollow noopener" target="_blank">Yepes Nbody Slides and references therein</a></li> <li><a href="http://popia.ft.uam.es/ACO/links.html" rel="external nofollow noopener" target="_blank">Knebe’s lecture</a></li> </ul> <h2 id="overview">Overview</h2> <p>(simplified pseudo-code for the main loop in <code class="language-plaintext highlighter-rouge">run.c</code>)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-------- Initializations ------------
hci_init (what is HCI?)
get_unit_system (independent of a)
gravpm_init_periodic
DriftKickTimes times = init_driftkicktime(ti_init)
atime = get_atime(times.Ti_Current)

----------- Main Loop -------------
times.Ti_Current = find_next_kick(times.Ti_Current, times.mintimebin);
atime = get_atime(times.Ti_Current);
if pm and all.randomoffset:
	update_random_offset(PartManager, rel_random_shift, All.RandomParticleOffset)

#--------- Drift/Ddcomp ----------
if PM_step or active_timebin:
	drift_all_particles(Ti_Last, times.Ti_Current, &amp;All.CP, rel_random_shift)
	domain_decompose_full(ddecomp)
	
update_lastactive_drift(&amp;times);

build_active_particles(&amp;Act, &amp;times, NumCurrentTiStep, atime);

#----------- Hydro ---------------
density(&amp;Act, 1, DensityIndependentSphOn(), All.BlackHoleOn, times, &amp;All.CP, &amp;sph_predicted, GradRho_mag, &amp;gasTree)
# update smoothing lengths in tree
force_update_hmax(Act.ActiveParticle, Act.NumActiveParticle, &amp;gasTree, ddecomp);
hydro_force(&amp;Act, atime, &amp;sph_predicted, times, &amp;All.CP, &amp;gasTree);

#---------- PM --------------------
force_tree_full(&amp;Tree, ddecomp, HybridNuTracer, All.OutputDir);
gravpm_force(&amp;pm, &amp;Tree, &amp;All.CP, atime, units.UnitLength_in_cm, All.OutputDir, header-&gt;TimeIC, All.FastParticleType);

#--------- Tree ------------------
force_tree_full(&amp;Tree, ddecomp, HybridNuTracer, All.OutputDir);
grav_short_tree(&amp;Act, &amp;pm, &amp;Tree, NULL, rho0, HybridNuTracer, All.FastParticleType, times.Ti_Current);

#--------- First Half Kick ------------------
apply_half_kick(&amp;Act, &amp;All.CP, &amp;times, atime); # both grav and hydro
update_kick_times(&amp;times);
if pm:
	apply_PM_half_kick(&amp;All.CP, &amp;times);
	
#------- Cooling and extra physics --------
metal_return();
fof_seed(); # seed BH
do_heiii_reionization();
calculate_uvbg();
blackhole();
cooling_and_starformation();
force_tree_free(&amp;Tree);

#--------- Output ----------------
if(WriteSnapshot):
	write_checkpoint();
	fof_save_groups();
 write_cpu_log();

#---------- Second half kick --------
find_timesteps(&amp;Act, &amp;times, atime, All.FastParticleType, &amp;All.CP, asmth, NumCurrentTiStep == 0);
apply_half_kick(&amp;Act, &amp;All.CP, &amp;times, atime);
update_kick_times(&amp;times);
apply_PM_half_kick(&amp;All.CP, &amp;times);

</code></pre></div></div> <h2 id="io">I/O</h2> <p>Driver:</p> <p><code class="language-plaintext highlighter-rouge">checkpoint.c/write_checkpoint(int snapnum, int WriteGroupID, int MetalReturnOn, double Time, const Cosmology * CP, const char * OutputDir, const int OutputDebugFields)</code></p> <p><code class="language-plaintext highlighter-rouge">petaio.c/petaio_save_snapshot(const char * fname, struct IOTable * IOTable, int verbose, const double atime, const Cosmology * CP)</code></p> <h2 id="time-integration">Time integration</h2> <p>Detailed time integration scheme can be find in Section 4 of the <a href="https://wwwmpa.mpa-garching.mpg.de/gadget4/gadget4-code-paper.pdf" rel="external nofollow noopener" target="_blank">gadget4 paper</a>, also see <a href="https://arxiv.org/pdf/astro-ph/9710043.pdf" rel="external nofollow noopener" target="_blank">Quinn1997</a>: \(\mathbf{x}\left(\tau_n+\Delta \tau\right)=\mathbf{x}\left(\tau_n\right)+\mathbf{p}_n\left(\tau_n\right) \int_{\tau_n}^{\tau_n+\Delta \tau} \frac{\mathrm{d} \tau}{a^2 H(a)}\)</p> \[\mathbf{p}\left(\tau_n+\Delta \tau\right)=\mathbf{p}\left(\tau_n\right)+\mathbf{a}_n\left(\tau_n\right) \int_{\tau_n}^{\tau_n+\Delta \tau} \frac{\mathrm{d} \tau}{a H(a)}\] <p>where $\mathbf{p} = a^2\dot{\mathbf{x}}$, $\mathbf{a} = a\dot{\mathbf{p}}$, $\tau = log(a)$, $dt = dlog(a)/H(a)$.</p> <p><strong>Relation with physical quantities</strong></p> <p>$\mathbf{r},\mathbf{v},\mathbf{f}$ are physical distance, velocity and acceleration; $\mathbf{x},\mathbf{p},\mathbf{a}$ are code distance, velocity and acceleration. \(\mathbf{r} = a \mathbf{x}\) \(\mathbf{v} = d\mathbf{r}/dt = \frac{1}{a}\mathbf{p} + \dot{a}\mathbf{x}\) \(\mathbf{f} = d\mathbf{v}/dt = \dot{\mathbf{p}}/a + \ddot{a}\mathbf{x} = \frac{1}{a^2} \mathbf{a} + \ddot{a} \mathbf{x}\)</p> <p><strong><a href="https://github.com/N-BodyShop/changa/wiki/ChaNGa-User-Guide#changa-with-black-holes" rel="external nofollow noopener" target="_blank">ChaNGa Notes</a></strong></p> <blockquote> <p>Here be Dragons.</p> <p>Going from comoving distance to physical distance is straightforward: r_phys = a r_cm. Physical velocity requires including the Hubble flow: v_phys = a (v_cm + H r_cm), where H is the hubble constant at the given redshift. Beware that v_circular is calculated differently, and therefore scales differently: v_c_phys = v_c_cm/sqrt(a). Finally, sometimes you want to know the ratio of the density to the critical density (e.g. to calculate the virial radius). This depends on cosmology. For Lambda + Matter critical Universes, we have rho/rho_c = rho_cm/(a^3 Omega_Lambda + Omega_matter), where the Omegas are present values and rho_c at the present is 1 as described above.</p> </blockquote> <p><strong>In MP-gadget</strong></p> <p><code class="language-plaintext highlighter-rouge">get_exact_draft_fac</code> called in <code class="language-plaintext highlighter-rouge">drift.c</code>,<code class="language-plaintext highlighter-rouge">exchange.c</code>,<code class="language-plaintext highlighter-rouge">hydra.c</code>,<code class="language-plaintext highlighter-rouge">lightcone.c</code></p> <p><code class="language-plaintext highlighter-rouge">get_exact_gravkick_fac</code> called in <code class="language-plaintext highlighter-rouge">blackhole.c</code>,<code class="language-plaintext highlighter-rouge">density.c</code>,<code class="language-plaintext highlighter-rouge">hydra.c</code>,<code class="language-plaintext highlighter-rouge">timestep.c</code>,<code class="language-plaintext highlighter-rouge">wind.c</code></p> <p>In <code class="language-plaintext highlighter-rouge">drift.c</code></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ddrift = get_exact_drift_factor(CP, ti0, ti1);
pp-&gt;Pos[j] += pp-&gt;Vel[j] * ddrift + random_shift[j];
</code></pre></div></div> <p>In <code class="language-plaintext highlighter-rouge">timefac.c</code>:</p> <p><code class="language-plaintext highlighter-rouge">drift_integ(a)</code> = $1/H(a)/a^3$</p> <p><code class="language-plaintext highlighter-rouge">gravkick_integ(a)</code> = $1/H(a)/a^2$</p> <p><code class="language-plaintext highlighter-rouge">hydrokick_integ(a)</code> = $1/H(a)/a^{3(\gamma-1)+1}$</p> <p><code class="language-plaintext highlighter-rouge">get_exact_factor(a)</code>: integrate draft/kick factor from t0 to t1 \(\int_{a0}^{a1} fac(a)\,da\)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a0 = exp(loga_from_ti(t0))
</code></pre></div></div> <h4 id="note-on-hubble">note on hubble</h4> <p><code class="language-plaintext highlighter-rouge">CP-&gt;HubbleParam</code>: little h unit of 100km/s/Mpc</p> <p><code class="language-plaintext highlighter-rouge">CP-&gt;Hubble</code>: <code class="language-plaintext highlighter-rouge">CP-&gt;Hubble = HUBBLE * units.UnitTime_in_s</code>, 100km/s/Mpc in internal unit; set to 0.1 by default</p> <p><code class="language-plaintext highlighter-rouge">HUBBLE</code>: <code class="language-plaintext highlighter-rouge">#define HUBBLE 3.2407789e-18 /* in h/sec */</code> = 100 km/s/Mpc in cgs</p> <p><code class="language-plaintext highlighter-rouge">HUBBLE * CP-&gt;HubbleParam</code>: hubble constant at z=0 in cgs</p> <p><code class="language-plaintext highlighter-rouge">CP-&gt;Hubble * CP-&gt;HubbleParam</code>: hubble constant at z=0 in internal time unit (UnitTime_in_s, 978 Myr)</p> <p><code class="language-plaintext highlighter-rouge">hubble_func(a) * CP-&gt;HubbleParam</code>: hubble constant at z in internal time unit</p> <p><code class="language-plaintext highlighter-rouge">UnitTime_in_s = 3.08568e+16</code>: chose such that <code class="language-plaintext highlighter-rouge">CP-&gt;Hubble=0.1</code>?</p> <h2 id="timestepping">Timestepping</h2> <h3 id="timelineconversions">Timeline/Conversions</h3> <p><strong>Basic variables</strong></p> <p>The simulated timespan is mapped onto the integer interval [0,TIMEBASE]</p> <p><em>Each integer time stores in the first 10 bits the snapshot number; Then the rest of the bits are the standard integer timeline, which should be a power-of-two hierarchy</em></p> <p>timebin是说bin的size</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TIMEBINS=20
TIMEBASE = 2^21
MAXSNAPSHOTS = 2^11
dti_from_timebin(bin) = 2^(bin)
</code></pre></div></div> <p><strong>Sync points and output</strong></p> <p>2 « 1 = 4 and 2 « 2 = 8; 4 » 1 = 2 (and 5 » 1 = 2 since you round down); The bitwise representation of a is shifted left b bits. This is the same as multiplying by (2 to the power of b).</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	SyncPoints[0].a = TimeIC;
	SyncPoints[0].loga = log(TimeIC);
	
	SyncPoints[NSyncPoints].a = TimeMax;
    SyncPoints[NSyncPoints].loga = log(TimeMax);
        
    for(i = 0; i &lt; NSyncPoints; i++) {
        SyncPoints[i].ti = (i * 1L) &lt;&lt; (TIMEBINS);
    }
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">SyncPoints[i].ti</code>: first 11 bits=i; last 21 bits=0.</p> <p><code class="language-plaintext highlighter-rouge">setup_sync_points(Cosmology * CP, double TimeIC, double TimeMax, double no_snapshot_until_time, int SnapshotWithFOF)</code>: initialize all sync points, their time, loga, writeFOF, etc.. <code class="language-plaintext highlighter-rouge">no_snapshot_until_time</code> ensures that we do not write output before the restart snapshot, even if those redshifts appears in the output list.</p> <p><strong>Integer timeline and loga</strong></p> <p><em>Basically, the timeline is chopped into chunks based by syncpoints (snapshots), then the timeline between two consecutive snapshots is further divided into 2^21 ticks, everything is then in units of these ticks.</em></p> <p><code class="language-plaintext highlighter-rouge">Dloga_interval_ti(inttime_t ti)</code>: returns the dloga corresponding to dti=1 at the current ti (valid between last snap and next snap), i.e. <code class="language-plaintext highlighter-rouge">(SyncPoints[lastsnap+1].loga - SyncPoints[lastsnap].loga)/2^21</code>; this number will differ from snap to snap.</p> <p><code class="language-plaintext highlighter-rouge">loga_from_ti(inttime_t ti)</code>: returns the current loga, calculated from <code class="language-plaintext highlighter-rouge">SyncPoints[lastsnap].loga + dti * Dloga_interval_ti(ti)</code>, where <code class="language-plaintext highlighter-rouge">dti = ti - SyncPoints[lastsnap].ti</code> = the last 21 bits of ti?</p> <p><code class="language-plaintext highlighter-rouge">dloga_from_dti(inttime_t dti, const inttime_t Ti_Current)</code>: get the dloga from dti according to the current snapshot interval: <code class="language-plaintext highlighter-rouge">returns Dloga_interval_ti(Ti_Current) * dti</code> <em>but what if dti crosses the next snap?</em></p> <p><code class="language-plaintext highlighter-rouge">get_dloga_for_bin(int timebin, const inttime_t Ti_Current)</code>: returns the length of the time bin: <code class="language-plaintext highlighter-rouge">Dloga_interval_ti(Ti_Current) * 2^timebin</code></p> <p><code class="language-plaintext highlighter-rouge">init_timebins(TimeInit) = ti_from_loga(log(TimeInit))</code></p> <p><code class="language-plaintext highlighter-rouge">int is_timebin_active(int i, inttime_t current)</code> 如果current可以被第i个bin的长度整除（<code class="language-plaintext highlighter-rouge">dti_from_timebin(i)</code>），<strong>timebin</strong>而不是ti就active (ti=12的话，bin1，2 active，3不active). <strong>用法</strong>：<code class="language-plaintext highlighter-rouge">is_timebin_active(pp-&gt;TimeBinHydro, ti_current)</code>: 判断在某一个time ti，某一个particle的特定calculation是不是active.</p> <h3 id="timestep-calculations">Timestep calculations</h3> <p><strong>KD times</strong></p> <p><code class="language-plaintext highlighter-rouge">find_timesteps</code> (called before the second half kick): assign new timesteps to the active particles, now that we know they have synched TiKick and TiDrift, and advance the PM timestep.</p> <p><code class="language-plaintext highlighter-rouge">apply_half_kick(const ActiveParticles * act, Cosmology * CP, DriftKickTimes * times, const double atime)</code> 对每一个bin （1-20），<code class="language-plaintext highlighter-rouge">new_kick = times-&gt;Ti_kick[bin] + dti_from_timebin(bin)/2</code></p> <p>For each bin, plan to kick from <code class="language-plaintext highlighter-rouge">times-&gt;Ti_kick[bin]</code> to <code class="language-plaintext highlighter-rouge">times-&gt;Ti_kick[bin] + dti_from_timebin(bin)/2</code>, the kick factors are stored in <code class="language-plaintext highlighter-rouge">gravkick[bin]</code></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if(is_timebin_active(bin_gravity, times-&gt;Ti_Current)) {
   		do_grav_short_range_kick(&amp;P[i], P[i].FullTreeGravAccel, gravkick[bin_gravity]);
   		do_hydro_kick(i, dt_entr, gravkick[bin_hydro], hydrokick[bin_hydro], atime);
</code></pre></div></div> <p>Note: <code class="language-plaintext highlighter-rouge">apply_hydro_half_kick</code> done separately only under hierarchical gravity</p> <p><strong>grav-timestep</strong></p> <p>Basically a small fraction of softening/acc</p> <p><code class="language-plaintext highlighter-rouge">get_timestep_gravity_dloga</code>: $dt = \sqrt{2 \epsilon_{\rm tol} \, a \, \epsilon_g / \mathbf{a}_{\rm grav}}$</p> <p><strong>hydro-timestep</strong></p> <p><em>ref: <a href="https://wwwmpa.mpa-garching.mpg.de/gadget4/gadget4-code-paper.pdf" rel="external nofollow noopener" target="_blank">gadget4 paper</a> Eq. 77-81</em></p> <ul> <li>local particle-based Courant-Friedrichs-Lewy (CFL) hydrodynamic timestep (smoothing length/sound speed)</li> </ul> \[\Delta t_i^{\mathrm{cfl}}=C_{\mathrm{CFL}} 2 h_i / v_i^{\mathrm{sig}, \max }\] <ul> <li>timestep criterion that restricts the al- lowed rate of change of the smoothing length (or equivalently den- sity) per timestep</li> </ul> \[\Delta t_i^{\mathrm{dens}}=C_{\mathrm{CFL}} \frac{h_i}{\left|\mathrm{~d} h_i / \mathrm{d} t\right|},\] <p><strong>long-range timestep</strong> <code class="language-plaintext highlighter-rouge">get_long_range_timestep_dloga</code>: just set PM step to maxtimebin for non-cosmological sim; pm step will be shortened to the longest tree timestep in find_timestep().</p> <h2 id="gravity">Gravity</h2> <p>Basic equation of motion (x: comoving) (<a href="https://arxiv.org/pdf/astro-ph/0411730.pdf" rel="external nofollow noopener" target="_blank">reference1</a>,<a href="https://arxiv.org/pdf/0801.1023.pdf" rel="external nofollow noopener" target="_blank">reference2</a>):</p> \[\ddot{x} + 2H(a)\dot{x} = \frac{1}{a}\,\nabla\phi\] \[\nabla^2\phi = 4\pi G \bar{\rho}(t)a^2\delta = \frac{3}{2}H_0 ^2\Omega_0 \frac{\delta}{a}\] \[\frac{\mathrm{d} \mathbf{v}}{\mathrm{d} t} =-\frac{\nabla \Phi}{a}-\mathbf{v} H(a)\] <p>where $\mathbf{v}$ is proper peculiar velocity.</p> <h3 id="pp-force">PP Force</h3> <p>In <code class="language-plaintext highlighter-rouge">gravshort_tree.c</code>:</p> <p><code class="language-plaintext highlighter-rouge">apply_accn_to_output</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fac = mass / (r2 * r);
for(i = 0; i &lt; 3; i++)
    output-&gt;Acc[i] += dx[i] * fac;
    output-&gt;Potential += facpot;
</code></pre></div></div> \[\phi(\mathbf{x})= -\sum_{j=1}^N \frac{m_j}{\left|\mathbf{x}_j-\mathbf{x}+\mathbf{q}_j^{\star}\right|+\epsilon\left(\left|\mathbf{x}_j-\mathbf{x}+\mathbf{q}_j^{\star}\right|\right)} +\sum_{j=1}^N m_j \psi\left(\mathbf{x}_j-\mathbf{x}+\mathbf{q}_j^{\star}\right)\] <h3 id="pm-force">PM Force</h3> <p>Reference: <a href="https://core.ac.uk/download/pdf/25290081.pdf" rel="external nofollow noopener" target="_blank">SUPERBOX paper</a></p> <p>Possion’s equation in real space (a convolution of density rho with the Green’s function H):</p> \[\Phi_{i j k}=G \sum_{a, b, c=0}^{N-1} \varrho_{a b c} \cdot H_{a-i, b-j, c-k}, \quad i, j, k=0, \ldots, N-1\] <p>where the Green’s function for gravivational potential is:</p> \[\begin{aligned} H_{i j k} &amp;=\frac{1}{\sqrt{i^2+j^2+k^2}}, \quad i, j, k=0,1, . ., N \\ H_{000} &amp;=4 / 3 . \end{aligned}\] <h3 id="units-and-scale-factors">units and scale factors</h3> <p>Scale factors</p> <p><code class="language-plaintext highlighter-rouge">P[i].Vel[k]</code> &lt;- $a\,v_{\rm pec}$;</p> <p><code class="language-plaintext highlighter-rouge">P[i].Pos[k]</code> &lt;- $x_{\rm prop}/a$;</p> <p><code class="language-plaintext highlighter-rouge">P[i].DFAccel[k]</code> &lt;- $a^2\,a_{\rm df}$;</p> <p>Code units</p> <p>velocity: $a\,km/s = 10^3\, m/s\;\times a$</p> <p>length: $kpc/h/a = 3.086\times 10^{19}\, m\;/h/a$;</p> <p>time: length/velocity = $[kpc]/[km/s] = 3.086e16\,s = 978\,Myr$; (any extra a or h?)</p> <p>acc: $a^2\times length/time^2 = [km/s]^2/[kpc] = 3.24 \times 10^{-14}\,m/s^2\;\times a^2$</p> <p>rho: $mass/length^2 = 1e10/h\,M_\odot/[kpc/h/a]^3 = 10^{10}\,a^3\,h^2 M_\odot/kpc^3 = 10\,a^3\,h^2 M_\odot/pc^3 = a^3\,h^2\;6.77\times 10^{-19}\,kg/m^3$</p> <h2 id="hydrosph">Hydro/SPH</h2> <p><strong>basic thermo relations</strong></p> <p>Equation of state \(P_i=u_i(\gamma-1) \rho_i\)</p> <p>Entropy function A \(P_i=A_i(s) \rho_i^\gamma\)</p> <p>Energy, entropy, density, and pressure \(u \equiv \bar{P}_i /\left[(\gamma-1) \bar{\rho}_i\right]=(\gamma-1)^{-1} A_i \bar{\rho}_i^{\gamma-1}\)</p> <p><strong>Euler equations</strong> (see <a href="https://www.ita.uni-heidelberg.de/~dullemond/lectures/num_fluid_2011/Chapter_12.pdf" rel="external nofollow noopener" target="_blank">here</a>)</p> \[\begin{gathered} \frac{\mathrm{d} \rho}{\mathrm{d} t}+\rho \nabla \cdot \mathbf{v}=0, \\ \frac{\mathrm{d} \mathbf{v}}{\mathrm{d} t}+\frac{\nabla P}{\rho}=0, \\ \frac{\mathrm{d} u}{\mathrm{~d} t}+\frac{P}{\rho} \nabla \cdot \mathbf{v}=0, \end{gathered}\] <p>where $\mathrm{d} / \mathrm{d} t=\partial / \partial t+\mathbf{v} \cdot \nabla$ is the convective derivative.</p> <p><strong>SPH formulation</strong></p> <p>Pressure-entropy formulation \(\bar{P}_i=y_i^\gamma=\left[\sum_{j=1}^N m_j A_j^{1 / \gamma} W_{i j}\left(h_i\right)\right]^\gamma\)</p> <p>sound speed in pressure-entropy sph: \(c_i = \sqrt{\gamma\,P_i/\rho_{u,i}}\) standard sph \(c_i = \sqrt{\gamma\,P_i/\rho_i}\)</p> <p>EOM: \(\begin{aligned} \frac{\mathrm{d} \mathbf{v}_i}{\mathrm{~d} t} &amp; =-\sum_{j=1}^N m_j\left(A_i A_j\right)^{\frac{1}{\gamma}}\left[\frac{f_i \bar{P}_i}{\bar{P}_i^{2 / \gamma}} \nabla_i W_{i j}\left(h_i\right)+\frac{f_j \bar{P}_j}{\bar{P}_j^{2 / \gamma}} \nabla_i W_{i j}\left(h_j\right)\right] \\ f_i &amp; =\left[1+\frac{h_i}{3 \bar{P}_i^{1 / \gamma}} \frac{\partial \bar{P}_i^{1 / \gamma}}{\partial h_i}\right]^{-1} \end{aligned}\)</p> <h3 id="entropy">entropy</h3> <p>in <code class="language-plaintext highlighter-rouge">init.c</code>: <code class="language-plaintext highlighter-rouge">SphP[i].Entropy = GAMMA_MINUS1 * u_init / pow(SphP[i].EgyWtDensity / a3 , GAMMA_MINUS1);</code></p> <p>in <code class="language-plaintext highlighter-rouge">winds.c</code>: <code class="language-plaintext highlighter-rouge">SPHP(other).Entropy += therm/enttou;</code></p> <p>in <code class="language-plaintext highlighter-rouge">sfr_eff.c</code>: <code class="language-plaintext highlighter-rouge">enttou = entropy_to_u(SPHP(i).Density, a3inv);</code></p> <p>in <code class="language-plaintext highlighter-rouge">blackhole.c</code>: <code class="language-plaintext highlighter-rouge">enttou = pow(SPHP(other).Density * BH_GET_PRIV(lv-&gt;tw)-&gt;a3inv, GAMMA_MINUS1) / GAMMA_MINUS1;</code></p> <p>\(s2u = (\rho/a^3)^{\gamma-1}/(\gamma - 1)\) (same as the basic thermal relation above)</p> <p><code class="language-plaintext highlighter-rouge">O-&gt;EgyRho += mass_j * EntVarPred * wk; SPHP(i).EgyWtDensity /= EntPred;</code></p> <h3 id="density-estimation-densityc">density estimation (density.c)</h3> <p>Initialize the kernel by type; calculate the gas particles within the kernel (depends on kernel type, 113 for quintic)</p> <pre><code class="language-double">GetNumNgb(enum DensityKernelType KernelType)
{
    DensityKernel kernel;
    density_kernel_init(&amp;kernel, 1.0, KernelType);
    return density_kernel_desnumngb(&amp;kernel, DensityParams.DensityResolutionEta);
}
</code></pre> <p><code class="language-plaintext highlighter-rouge">EntVarPred = exp(1./GAMMA * log(EntVarPred));</code> why??</p> <h3 id="hydrohydrac">hydro(hydra.c)</h3> <p><code class="language-plaintext highlighter-rouge">PressurePred(MyFloat EOMDensityPred, double EntVarPred)</code>: <code class="language-plaintext highlighter-rouge">return pow(EntVarPred * EOMDensityPred, GAMMA);</code> This is likely $\bar{P}<em>i=y_i^\gamma=\left[\sum</em>{j=1}^N m_j A_j^{1 / \gamma} W_{i j}\left(h_i\right)\right]^\gamma$</p> <p>Then ` HYDRA_GET_PRIV(tw)-&gt;PressurePred[i] = PressurePred(SPH_EOMDensity(&amp;SphP[i]), SPH_predicted-&gt;EntVarPred[i]);<code class="language-plaintext highlighter-rouge"> </code>SPH_EOMDensity` returns either Density or EgyWtDensity</p> <p>Key: <code class="language-plaintext highlighter-rouge">hfc += P[other].Mass * (dwk_i*iter-&gt;p_over_rho2_i*EntVarPred/I-&gt;EntVarPred + dwk_j*p_over_rho2_j*I-&gt;EntVarPred/EntVarPred) / r;</code></p> <p>hydro force added in <code class="language-plaintext highlighter-rouge">hydro.c</code>: <code class="language-plaintext highlighter-rouge">O-&gt;Acc[d] += (-hfc * dist[d]);</code> dist: distance</p> <p><code class="language-plaintext highlighter-rouge">TREEWALK_REDUCE(SPHP(place).HydroAccel[k], result-&gt;Acc[k]);</code></p> <p>###</p> <h2 id="heating-cooling-ionization-equilibrium">Heating, Cooling, ionization equilibrium</h2> <p>In cooling.c</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>double
get_neutral_fraction_phys_cgs(double density, double ienergy, double helium, const struct UVBG * uvbg, double * ne_init)                                                              
{
    double logt;
    double ne = get_equilib_ne(density, ienergy, helium, &amp;logt, uvbg, *ne_init);
    double nh = density * (1-helium);
    double photofac = self_shield_corr(nh, logt, uvbg-&gt;self_shield_dens);
    *ne_init = ne/nh;
    return nH0_internal(logt, ne, uvbg, photofac);
</code></pre></div></div> <p>Set of ionization equilibrium equations from KWH95:</p> \[\begin{aligned} n_{\mathrm{H}_0} &amp; =n_{\mathrm{H}} \alpha_{\mathrm{H}_{+}} /\left(\alpha_{\mathrm{H}_{+}}+\Gamma_{\mathrm{eH}_0}+\Gamma_{\gamma \mathrm{H}_0} / n_{\mathrm{e}}\right) \\ n_{\mathrm{H}_{+}} &amp; =n_{\mathrm{H}}-n_{\mathrm{H}_0}, \\ n_{\mathrm{He}_{+}} &amp; =y n_{\mathrm{H}} /\left[1+\left(\alpha_{\mathrm{He}_{+}}+\alpha_{\mathrm{d}}\right) /\left(\Gamma_{\mathrm{eHe}_0}+\Gamma_{\gamma \mathrm{He}_0} / n_{\mathrm{e}}\right)+\left(\Gamma_{\mathrm{eHe}_{+}}+\Gamma_{\gamma \mathrm{He}_{+}} / n_{\mathrm{e}}\right) / \alpha_{\mathrm{He}_{++}}\right] \\ n_{\mathrm{He}_0} &amp; =n_{\mathrm{He}_{+}}\left(\alpha_{\mathrm{He}_{+}}+\alpha_{\mathrm{d}}\right) /\left(\Gamma_{\mathrm{eHe}_0}+\Gamma_{\gamma \mathrm{He}_0} / n_{\mathrm{e}}\right) \\ n_{\mathrm{He}_{++}} &amp; =n_{\mathrm{He}_{+}}\left(\Gamma_{\mathrm{eHe}_{+}}+\Gamma_{\gamma \mathrm{He}_{+}} / n_{\mathrm{e}}\right) / \alpha_{\mathrm{He}_{++}} \\ n_{\mathrm{e}} &amp; =n_{\mathrm{H}_{+}}+n_{\mathrm{He}_{+}}+2 n_{\mathrm{He}_{++}} . \end{aligned}\] <h2 id="star-formation">Star-formation</h2> <blockquote> <p>“The star formation model is unchanged from Feng et al. (2016a), itself an implementation of Springel &amp; Hernquist (2003). Gas is allowed to cool both radiatively (Katz et al. 1996) and via metal line cooling. We include self-shielding of dense gas via the fitting function of Rahmati et al. (2013). We approximate the metal cooling rate by scaling a solar metallicity template according to the metallicity of gas particles, following Vogelsberger et al. (2014). We include a correction for the formation of molecular hydrogen, and its effect on star formation at low metallicities, according to the prescription by Krumholz &amp; Gnedin (2011). Stars are formed with 1/4 of the mass of a gas particle. Since we have also implemented mass return, the mass of a gas particle after forming 4 stars may exceed zero. To prevent runaway enrichment as gas cycles between a star and gas particle, the 5th star spawned from a gas particle contains the entire mass of the particle.”</p> </blockquote> <h2 id="winds-stellar-feedbacks">winds, stellar feedbacks</h2> <blockquote> <p>“A stellar wind feedback model (Okamoto et al. 2010) is included, which assumes wind speeds proportional to the local one dimensional dark matter velocity dispersion σDM: vw = κwσDM , (3) where vw is the wind speed. κw is a dimensionless parameter, which we take to be 3.7 following Vogelsberger et al. (2013). Winds are sourced by newly formed star particles, which randomly pick gas particles from within their SPH smoothing length to become wind particles. The total mass loading is (vw/350km/s)−2 where 350 km/s is in physical units. Once a particle is in the wind, it is hydrodynamically”</p> </blockquote> <h2 id="metal-return">Metal return</h2> <blockquote> <p>“We include a model for the return of mass and metal to the inter-stellar medium from massive stars. The general approach follows Vogelsberger et al. (2013); Pillepich et al. (2018a), although the implementation is independent and we have created our own metal yield tables. Each star particle is treated as a single stellar population, with the proportion of massive stars set by a Chabrier initial mass function (IMF) (Chabrier 2003). Massive stars have a finite lifetime, set using the lifetime tables of Portinari et al. (1998), and at the end of this lifetime they return mass and metal to neighbouring gas particles proportional to their fraction of the underlying stellar population. Nine metal species are followed: H, He, C, N, O, Ne, Mg, Si, Fe. The total metallicity is tracked separately. Metal and mass yields from AGB stars, SnII and Sn1A are pre-compiled and included as a function of mass and stellar metallicity. Stars with masses 1M − 8M are assumed to return via an Asymptotic Giant Branch (AGB) stage, with”</p> </blockquote> <h2 id="parallelization">Parallelization</h2> <p>Useful resources</p> <ul> <li><a href="https://charm.cs.illinois.edu/newPapers/08-03/paper.pdf" rel="external nofollow noopener" target="_blank">ChaNGa MPI paper</a></li> </ul> </div> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"alshedivat/al-folio","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,a])=>giscusScript.setAttribute(t,a)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Nianyi Chen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: August 17, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>